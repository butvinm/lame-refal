<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WASM Test</title>
    </head>
    <body>
        <div style="display: flex; flex-direction: row; gap: 20px">
            <textarea
                id="points"
                rows="12"
                placeholder="x0;y0
x1;y1
x2;y2
x3;y3
x4;y4
"
            >
-3.24;0.8
-0.88;3.77
1.5;3.47
2.6;5.66
4.15;7.86
5.7;8.02
7.52;9.75
</textarea
            >
            <!--
8.44;11.46
9.63;11.15
10.58;12.63
11.54;14.74
12.7;12.86 -->
            <button id="interpolateButton">Interpolate!</button>
            <button id="stopButton">Stoooooop!</button>
        </div>

        <canvas id="wasmCanvas" width="2000px" height="2000px"></canvas>

        <script type="module">
            import { getLameWasmEnv, lamePostInit } from "../../../lib/lamelib.js";
            import { canvasPostInit, getCanvasWasmEnv } from "../canvas.js";

            const canvas = document.getElementById("wasmCanvas");
            const ctx = canvas.getContext("2d");

            const { instance } = await WebAssembly.instantiateStreaming(fetch("./main.wasm"), {
                env: {
                    ...getCanvasWasmEnv(ctx),
                    ...getLameWasmEnv(),
                },
            });

            lamePostInit(instance);
            canvasPostInit(instance);

            const data = new DataView(instance.exports.memory.buffer);
            const encoder = new TextEncoder();

            function writeString(offset, str) {
                const strEncoded = encoder.encode(str);
                let i = 0;
                while (i < strEncoded.length) {
                    data.setUint8(offset + i, strEncoded[i]);
                    i++;
                }
                data.setUint8(offset + i, 0);
                return offset + i + 1;
            }

            function pushArgv(argv_ptr, strings_ptr, str) {
                const next_string_ptr = writeString(strings_ptr, str);
                data.setUint32(argv_ptr, strings_ptr, true);
                const next_argv_ptr = argv_ptr + 4;
                return [next_argv_ptr, next_string_ptr];
            }

            const FF_SCALE = 1000;
            const LOWER_BOUND = -4;
            const UPPER_BOUND = 10;
            const MILLISECONDS_IN_SECOND = 1000;

            let stop = false;
            let start;
            let previous;
            const MAX_STEPS = 1000;
            let steps = MAX_STEPS;

            function next(timestamp) {
                if (stop || steps-- == 0) {
                    console.log("Stopped");
                    return;
                }

                const argv_ptr = instance.exports.malloc(1024);
                let next_argv_ptr = argv_ptr;
                const strings_ptr = instance.exports.malloc(4096);
                let next_string_ptr = strings_ptr;

                const ts = (timestamp - start) / MILLISECONDS_IN_SECOND; // second == 1 on x-axis
                console.log(ts);
                if (ts > UPPER_BOUND) {
                    console.log("Reached upper bound");
                    return;
                }

                const points = document.getElementById("points").value;

                [next_argv_ptr, next_string_ptr] = pushArgv(next_argv_ptr, next_string_ptr, ts.toString());
                [next_argv_ptr, next_string_ptr] = pushArgv(next_argv_ptr, next_string_ptr, points);

                try {
                    instance.exports.main(7, argv_ptr);
                } catch (e) {
                    if (e.message !== "Refal machine exited: 0") {
                        console.error(e);
                    }
                }

                window.requestAnimationFrame(next);
            }

            function interpolate() {
                steps = MAX_STEPS;
                ctx.clearRect(0, 0, 1000, 1000);
                window.requestAnimationFrame((timestamp) => {
                    start = timestamp - LOWER_BOUND * MILLISECONDS_IN_SECOND;
                    window.requestAnimationFrame(next);
                });
            }

            document.getElementById("interpolateButton").addEventListener("click", interpolate);

            document.getElementById("stopButton").addEventListener("click", () => {
                stop = true;
            });
        </script>
    </body>
</html>
